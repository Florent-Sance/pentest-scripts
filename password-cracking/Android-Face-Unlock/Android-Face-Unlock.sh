#!/bin/bash
# A. Cervoise 2015

function off
{
	/etc/init.d/networking stop
	/bin/echo 0 > /sys/devices/platform/bcm2708_usb/buspower;
}

function on
{
	/bin/echo 1 > /sys/devices/platform/bcm2708_usb/buspower;
	/bin/sleep 2;
	/etc/init.d/networking start
}

if [ $(/usr/bin/dpkg-query -W -f='${Status}' feh 2>/dev/null | /bin/grep -c "ok installed") -eq 0 ];
then
        /bin/echo "Please install feh (sudo apt-get install feh)"
        exit 1
fi

#Check if images folder exist and contains files
if [ -d "./images" ]
then
        if ! [ "$(/bin/ls -A ./images)" ] ;
        then
                /bin/echo "No file in ./images"
                exit 1
        fi
else
        /bin/echo "Please create an images folder"
        exit 1
fi

#Check if script is run as root
#Root privileges are needed in order to turn on/off the network/USB
if [ "$EUID" -ne 0 ]
then
	/bin/echo "Please run as root"
    exit 1
fi

for image in ./images/*
do
	#check if $image is an image
	if [ $(/usr/bin/file $image | /usr/bin/cut -d: -f2 | /bin/grep -c image) -eq 1 ];
	then
		/bin/echo $image
	fi
done

off
for image in ./images/*
do
	/bin/echo $image
	/bin/echo $image >> ../debug.txt
	#show the image
        /usr/bin/feh -g 240x320 $image &
        #wait with the image
        on
	/bin/sleep 4
        
        #head to get only the first line (second one is the grep) cut to 
        #get the process and do not kill the parent
        /bin/kill `ps -ef | /bin/grep feh | /usr/bin/head -n 1 | /usr/bin/cut -d\  -f 7` >> ../debug.txt
        off
	#sleep to get the screen turn off
	/bin/sleep 6
done

on

/bin/echo "End" >> ../debug.txt
/bin/echo "End of script"
