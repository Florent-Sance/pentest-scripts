#!/bin/bash
# A. Cervoise 2015

function off
{
        /etc/init.d/networking stop
        echo 0 > /sys/devices/platform/bcm2708_usb/buspower;
}

function on
{
        echo 1 > /sys/devices/platform/bcm2708_usb/buspower;
        sleep 2;
        /etc/init.d/networking start
}

#Check if feh is installed
if [ $(dpkg-query -W -f='${Status}' feh 2>/dev/null | grep -c "ok installed") -eq 0 ];
then
  echo "Please install feh (sudo apt-get install feh)"
  exit 1
fi

#Check if script is run as root
#Root privileges are needed in order to turn on/off the network/USB
if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

echo "Begin" >> debug.txt

let "state = 1"
for image in ./images/*
do
        echo $image
        echo $image >> ../debug.txt
        #show the image
        feh -g 240x320 $image &
        #wait with the image
        sleep 4

        #head to get only the first line (second one is the grep) cut to
        #get the process and do not kill the parent
        kill `ps -ef |grep feh |head -n 1 | cut -d\  -f 7` >> debug.txt

        #sleep to get the screen turn off
        sleep 6

        #wake the phone
        echo $state >> debug.txt
        if [[ $state == 1 ]]
        then
                let "state = 0"
                off >> debug.txt
        else
                let "state = 1"
                on >> debug.txt
        fi
        echo $state >> debug.txt
done

if [[ $state == 0 ]]
then
        on
fi
echo "End" >> debug.txt
echo "End of script"
