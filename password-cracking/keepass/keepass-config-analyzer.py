#!/home/bin/python
# A. Cervoise - 2013-03-29

import sys
import re
 
def regex_match(pattern, string):
    return re.compile(pattern).findall(string) != []
 
def cut(string, pattern):
    return string.partition('<' + pattern + '>')[2].partition('</' + pattern + '>')[0]

def main():
    if len(sys.argv)==1:
        print 'python keepass-config-analyzer.py path to KeePass.config.xml\n'
        print 'KeePass.config.xml can be found:\n'
        print 'Windows XP'
        print 'C:\Documents and Settings\username\Application Data\KeePass\KeePass.config.xml'
        print 'Windows Seven'
        print 'C:\Users\username\AppData\Roaming\KeePass\KeePass.config.xml'
        print 'Linux'
        print '/home/username/.config/KeePass/KeePass.config.xml'
    else:
        File = open(sys.argv[1], 'r')
         
        FileList = []
        FileListWithKey = []
         
        for line in File.readlines():
            if regex_match('<Path>', line):
                FileList.append(cut(line, 'Path'))
            elif regex_match('<DatabasePath>', line):
                FileListWithKey.append([cut(line, 'DatabasePath'), ''])
            elif regex_match('<KeyFilePath>', line):
                FileListWithKey[-1][1] = cut(line, 'KeyFilePath')
         
        FileList= sorted(list(set(FileList)))

        #if a DB is in bith list, we remove the DB from the list without keyfile
        for DataBase in FileListWithKey:
            if DataBase[0] in FileList:
                FileList.remove(DataBase[0])

        #print results
        for DataBase in FileList:
            print DataBase + '\n'

        print '---\n'

        for DataBase in FileListWithKey:
            print DataBase[0] + '\n' + DataBase[1] + '\n'

if __name__=="__main__":
    main()
